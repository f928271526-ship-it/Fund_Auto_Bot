name: 晚间自动复盘

on:
  schedule:
    # 每天北京时间 22:00 运行
    - cron: '0 14 * * 1-5'
  workflow_dispatch:

jobs:
  run_job:
    runs-on: ubuntu-latest
    
    steps:
    - name: 下载代码
      uses: actions/checkout@v2
      
    - name: 安装 Python 3.10
      uses: actions/setup-python@v2
      with:
        python-version: '3.10'
        
    - name: 安装依赖库
      run: |
        pip install akshare pandas requests sqlalchemy pymysql matplotlib seaborn cryptography

    - name: 生成云端专用配置文件
      run: |
        echo "import os" > config.py
        echo "def get_env(k, d): return os.environ.get(k, d)" >> config.py
        
        # --- 强制写入 bot 账号 ---
        echo "DB_CONFIG = {" >> config.py
        echo "    'user': 'bot'," >> config.py 
        echo "    'password': 'Bot123456'," >> config.py
        echo "    'host': os.environ.get('DB_HOST')," >> config.py
        echo "    'port': 3306," >> config.py
        echo "    'database': 'fund_db'" >> config.py
        echo "}" >> config.py
        
        # --- 写入其他配置 (只保留3只基金) ---
        echo "PUSH_CONFIG = {'token': os.environ.get('PUSH_TOKEN')}" >> config.py
        echo "MY_FUNDS = {" >> config.py
        echo "    '012363': '国泰证券'," >> config.py
        echo "    '006479': '广发纳指100'," >> config.py
        echo "    '012341': '华宝纳指精选'" >> config.py
        echo "}" >> config.py

    - name: 运行主程序
      env:
        # 🔥 关键修改：只传 HOST 和 TOKEN，不传 PASSWORD！
        # 这样 Python 就会读 config.py 里的 'bot'，而不会强行切回 'root'
        DB_HOST: ${{ secrets.DB_HOST }}
        PUSH_TOKEN: ${{ secrets.PUSH_TOKEN }}
      run: python main.py